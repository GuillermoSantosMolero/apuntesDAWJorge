Guillermo Santos Molero

CREATE OR REPLACE PROCEDURE FACTURACION 
(
  P_VUELO IN NUMBER
) IS
CURSOR C_PASAJERO IS
SELECT *
FROM PASAJE
WHERE IDVUELO=P_VUELO
ORDER BY dni;
V_MALETAS NUMBER;
V_PESO NUMBER;
V_COSTEADICIONAL NUMBER;
V_PRECIOBASE NUMBER;
BEGIN
  SELECT PRECIOBASE INTO V_PRECIOBASE FROM VUELO WHERE IDVUELO=P_VUELO;
  FOR R_PASAJERO IN C_PASAJERO LOOP
    SELECT COUNT(E.DNI) MALETAS,SUM(e.peso) PESO INTO V_MALETAS,V_PESO
    FROM EQUIPAJE E
    WHERE e.dni=R_PASAJERO.DNI
    AND e.idvuelo=P_VUELO;
    V_COSTEADICIONAL:=(TRUNC(V_MALETAS/2,0)*4);
    IF V_PESO>25 THEN
        V_COSTEADICIONAL:=V_COSTEADICIONAL+(V_PESO-25);
    END IF;
    UPDATE PASAJE SET IMPORTE=V_PRECIOBASE+V_COSTEADICIONAL WHERE IDVUELO=P_VUELO AND DNI=R_PASAJERO.DNI;
  END LOOP;
END FACTURACION;